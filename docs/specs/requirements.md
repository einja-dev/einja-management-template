# マジックリンク認証機能 要件定義書

## 概要
パスワードレス認証を実現するマジックリンク機能を実装し、ユーザーのログイン体験を向上させます。メールアドレスに送信される一時的なリンクをクリックすることで、パスワード入力なしに安全な認証を可能にします。

## AS-IS（現状）

### 現在の実装状況
- 従来のパスワードベース認証のみ対応
- ユーザーは複雑なパスワードを記憶する必要がある
- パスワードリセット機能は別途実装されている
- 2要素認証は未実装

### 現状の課題
- パスワード忘れによるログイン失敗が頻発（月間約15%のユーザー）
- 弱いパスワードによるセキュリティリスク
- パスワード管理の煩雑さによるユーザー離脱
- モバイルデバイスでのパスワード入力の不便さ

## TO-BE（目標状態）

### 実現したい姿
- メールアドレスのみでログイン可能なシステム
- ワンクリックで完了する認証フロー
- 時限式の安全なトークンによる認証
- モバイルフレンドリーな認証体験

### 期待される改善
- ログイン成功率の向上（95%以上を目標）
- パスワード関連のサポート問い合わせ80%削減
- セキュリティの向上（トークンの有効期限管理）
- ユーザー体験の大幅な改善

## ビジネス価値
- **問題**: パスワード管理の煩雑さによるユーザー離脱とセキュリティリスク
- **解決策**: メールベースのワンタイム認証リンクによるパスワードレス認証
- **期待効果**: ユーザー満足度向上、サポートコスト削減、セキュリティ強化

## スコープ
### 含まれるもの
- マジックリンクの生成・送信機能
- トークン検証とセッション管理
- リンクの有効期限管理（15分）
- 再送信機能
- ログアウト機能の改修

### 含まれないもの
- SMS認証
- ソーシャルログイン連携
- 生体認証
- 既存パスワード認証の削除（並行運用）

## ユーザーストーリー

### Story 1: マジックリンクのリクエスト
**As a** ユーザー
**I want to** メールアドレスを入力してログインリンクを受け取りたい
**So that** パスワードを覚える必要なくログインできる

#### 受け入れ基準
- [ ] Given: ログインページにアクセスした
      When: 有効なメールアドレスを入力して送信
      Then: 成功メッセージが表示され、メールが送信される
- [ ] Given: ログインページにアクセスした
      When: 無効なメールアドレスを入力
      Then: エラーメッセージが表示される
- [ ] Given: マジックリンクをリクエスト済み
      When: 1分以内に再度リクエスト
      Then: レート制限エラーが表示される

#### 実装の優先順位
P0 (必須)

---

### Story 2: マジックリンクによる認証
**As a** ユーザー
**I want to** メール内のリンクをクリックして認証を完了したい
**So that** 素早く安全にログインできる

#### 受け入れ基準
- [ ] Given: 有効なマジックリンクを受信した
      When: リンクをクリック
      Then: 自動的にログインされ、ダッシュボードへリダイレクト
- [ ] Given: 期限切れのリンクを受信した
      When: リンクをクリック
      Then: 期限切れエラーが表示され、再送信オプションが提示される
- [ ] Given: 既に使用済みのリンクを受信した
      When: 再度リンクをクリック
      Then: 使用済みエラーが表示される

#### 実装の優先順位
P0 (必須)

---

### Story 3: セキュリティ通知
**As a** ユーザー
**I want to** 新しいデバイスからのログインを通知してもらいたい
**So that** 不正アクセスを検知できる

#### 受け入れ基準
- [ ] Given: 新しいデバイスからマジックリンクでログイン
      When: 認証が成功
      Then: セキュリティ通知メールが送信される
- [ ] Given: セキュリティ通知を受信
      When: 身に覚えのないログイン
      Then: ワンクリックでセッションを無効化できる

#### 実装の優先順位
P1 (重要)

## 詳細なビジネス要件

### 認証トークン要件
#### マジックリンクトークン仕様
**要件内容**:
- 暗号学的に安全な256ビットのランダムトークン
- Base64URLエンコード形式で43文字
- トークンはデータベースにハッシュ化して保存（bcrypt使用）
- 1ユーザーあたり同時に有効なトークンは1つまで

**OK例**:
- `AbC123XyZ_0987654321qWeRtYuIoP-asdfghjklZXCV` - 有効な43文字のBase64URL形式
- `1a2B3c4D5e6F7g8H9i0J_kLmNoPqRsTuVwXyZ-123456` - 英数字と安全な特殊文字のみ

**NG例**:
- `short123` - 長さ不足（43文字未満）
- `invalid/token+with=special*chars` - 許可されない特殊文字を含む
- `password123` - 推測可能な単純な文字列

### メール送信要件
#### マジックリンクメール仕様
**要件内容**:
- 件名: 「[サービス名] ログインリンクのお知らせ」
- 送信元: `noreply@example.com`
- HTMLとテキストの両形式で送信（マルチパート）
- リンクの有効期限を明記（15分）
- セキュリティ警告文を含める

**メール本文に含める要素**:
- ログインリンク（ボタンとテキストリンクの両方）
- 有効期限の明記
- 「このメールに心当たりがない場合」の説明
- サポート連絡先

**セキュリティ要件**:
- SPF、DKIM、DMARCの設定必須
- リンクはHTTPS必須
- リプレイアタック防止のため、使用済みトークンは即座に無効化

### レート制限要件
#### リクエスト制限仕様
**要件内容**:
- 同一IPアドレス: 1分あたり3回まで
- 同一メールアドレス: 1分あたり1回まで
- 1日あたりの最大リクエスト数: 同一メールアドレスで20回まで

**制限超過時の動作**:
- HTTPステータス429（Too Many Requests）を返す
- `Retry-After`ヘッダーで次回リクエスト可能時刻を通知
- エラーメッセージ: 「リクエスト回数の上限に達しました。しばらく待ってから再度お試しください。」

## 非機能要件

### パフォーマンス
- マジックリンク生成: 100ms以内
- メール送信: 3秒以内
- トークン検証: 50ms以内

### セキュリティ
- トークンは暗号学的に安全な乱数生成
- トークンの有効期限: 15分
- 使用済みトークンの即座の無効化
- レート制限: 1分あたり3回まで

### 可用性
- 99.9%以上のアップタイム
- メール配信成功率: 99%以上

## 技術的制約
- 既存の認証システムとの互換性維持
- 現行のセッション管理システムの活用
- メール送信にはSendGridを使用

## 依存関係
- メール送信サービス（SendGrid）
- Redis（トークン管理）
- 既存のユーザー管理システム

## リスクと対策
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| メール遅延 | 高 | 中 | 複数のメールプロバイダーのフォールバック設定 |
| トークン漏洩 | 高 | 低 | 短い有効期限とワンタイム使用制限 |
| フィッシング攻撃 | 中 | 中 | ドメイン検証とセキュリティヘッダーの実装 |

## 成功指標
- ログイン成功率: 95%以上
- 平均認証時間: 30秒以内
- パスワード関連問い合わせ: 80%削減
- ユーザー満足度スコア: 4.5/5.0以上

## タイムライン
- Phase 1: 基本的なマジックリンク機能（Story 1, 2）
- Phase 2: セキュリティ強化（Story 3）
- Phase 3: 分析とモニタリング機能